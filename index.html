<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>í•™ìƒíšŒ ë¬¼í’ˆ ëŒ€ì—¬ ì¥ë¶€</title>

<style>
body { font-family: Arial, sans-serif; margin: 20px; background:#ffffff; }
h1 { margin-bottom:10px; }

.notice-box {
  background:#f7f7f7;
  border:1px solid #ddd;
  padding:10px 14px;
  margin-bottom:14px;
  font-size:14px;
  line-height:1.7;
}

.top-area { margin-bottom:15px; display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
.form-area { margin-bottom:20px; }

select, input, button {
  padding:6px;
  margin-right:6px;
  font-size:14px;
}

table { width:100%; border-collapse:collapse; }
th, td {
  border:1px solid #ccc;
  padding:6px;
  text-align:center;
  font-size:14px;
}
th { background:#f2f2f2; }

button { cursor:pointer; }
button:disabled { opacity:0.5; cursor:not-allowed; }
.reset-btn { background:#eee; }

.overlay {
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.4);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:1000;
}

.guide-box {
  background:#fff;
  padding:20px;
  width:420px;
  border-radius:6px;
  text-align:center;
}

/* âœ… íƒ€ì´í‹€ ì˜† ë‚ ì§œ ë¼ë²¨ */
.date-label {
  font-size: 14px;
  color: #888;
  margin-left: 10px;
  font-weight: normal;
}

/* âœ… ìƒíƒœ ë±ƒì§€ */
.badge {
  display:inline-block;
  padding:2px 8px;
  border-radius:999px;
  font-size:12px;
  border:1px solid #ddd;
}
.badge.available { background:#f7fff7; }
.badge.rented { background:#fff7f7; border-color:#f2c9c9; }

/* âœ… ìƒë‹¨ ëª¨ë“œ í‘œì‹œ */
.mode-pill {
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:6px 10px;
  border:1px solid #ddd;
  border-radius:999px;
  background:#fff;
  font-size:13px;
}
.mode-dot {
  width:10px; height:10px; border-radius:50%;
  background:#bbb;
}
.mode-dot.admin { background:#2e7d32; }
.mode-dot.view { background:#999; }

.small {
  font-size:12px;
  color:#666;
}
</style>
</head>
<body>

<!-- ìµœì´ˆ ì ‘ì† ì•ˆë‚´ íŒì—… -->
<div id="guideOverlay" class="overlay">
  <div class="guide-box">
    <p>
      ğŸ“Œ <b>í•™ìƒíšŒ ë¬¼í’ˆ ëŒ€ì—¬ ì¥ë¶€ ì•ˆë‚´</b><br><br>
      1. ë¬¼í’ˆ ì„ íƒ í›„ ì´ë¦„Â·í•™ë²ˆ ì…ë ¥ â†’ <b>[ëŒ€ì—¬í•˜ê¸°]</b><br>
      2. ë°˜ë‚©ì€ <b>í•™ìƒíšŒ ë‹´ë‹¹ì í™•ì¸ í›„</b> ì²˜ë¦¬ë©ë‹ˆë‹¤.<br>
      3. ë¬¼í’ˆ ëŒ€ì—¬ëŠ” ìš´ì˜ ì‹œê°„ì¸ <b>10ì‹œ~18ì‹œ</b> ë‚´ì—ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.<br><br>
      âœ… <b>ì¼íšŒìš©í’ˆì€ ì¥ë¶€ë¥¼ ì‘ì„±í•˜ì§€ ì•Šì•„ë„ ë©ë‹ˆë‹¤.</b>
    </p>
    <button id="closeGuideBtn">í™•ì¸</button>
  </div>
</div>

<!-- âœ… íƒ€ì´í‹€ + ì˜¤ëŠ˜ ë‚ ì§œ -->
<h1>
  í•™ìƒíšŒ ë¬¼í’ˆ ëŒ€ì—¬ ì¥ë¶€
  <span id="todayLabel" class="date-label"></span>
</h1>

<!-- ìƒë‹¨ ê³µì§€ -->
<div class="notice-box">
âœ” ë¬¼í’ˆ ëŒ€ì—¬ëŠ” ìš´ì˜ ì‹œê°„ì¸ <b>10ì‹œ~18ì‹œ</b> ë‚´ì—ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.<br>
âœ” ë¬¼í’ˆ ë°˜ë‚© ë˜í•œ <b>ëŒ€ì—¬ ë‹¹ì¼ ìš´ì˜ ì‹œê°„ ë‚´</b>ì— ë¶€íƒë“œë¦½ë‹ˆë‹¤.<br>
âœ” ë°˜ë‚©ì€ <b>í•™ìƒíšŒ ë‹´ë‹¹ìì˜ í™•ì¸</b>ì´ í•„ìš”í•©ë‹ˆë‹¤.<br>
<span class="small">â€» ì´ í˜ì´ì§€ëŠ” ëˆ„êµ¬ë‚˜ ì¡°íšŒí•  ìˆ˜ ìˆìœ¼ë©°, ëŒ€ì—¬/ë°˜ë‚© ì²˜ë¦¬ëŠ” í•™ìƒíšŒ ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.</span>
</div>

<div class="top-area">
  <span class="mode-pill" id="modePill">
    <span class="mode-dot view" id="modeDot"></span>
    <span id="modeText">ì¡°íšŒ ì „ìš© ëª¨ë“œ</span>
  </span>

  <button id="adminSetBtn">ê´€ë¦¬ì ëª¨ë“œ ì‹¤í–‰</button>
  <button id="adminClearBtn">ê´€ë¦¬ì ëª¨ë“œ í•´ì œ</button>

  <button class="reset-btn" id="resetBtn">ì´ˆê¸°í™” (ìƒˆ ì¥ë¶€)</button>
  <button id="refreshBtn">ìƒˆë¡œê³ ì¹¨</button>
</div>

<div class="form-area">
  <select id="itemSelect"></select>
  <select id="itemNoSelect"></select>
  <input id="nameInput" placeholder="ì´ë¦„">
  <input id="studentInput" placeholder="í•™ë²ˆ">
  <button id="rentBtn">ëŒ€ì—¬í•˜ê¸°</button>
</div>

<table>
<thead>
<tr>
<th>ë²ˆí˜¸</th>
<th>ë¬¼í’ˆ</th>
<th>ë¬¼í’ˆë²ˆí˜¸</th>
<th>ìƒíƒœ</th>
<th>ì´ë¦„</th>
<th>í•™ë²ˆ</th>
<th>ëŒ€ì—¬ ì‹œê°</th>
<th>ë°˜ë‚© ì‹œê°</th>
<th>ë°˜ë‚©</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>

<script>
/** ===============================
 * âœ… ë„ˆê°€ ë°”ê¿€ ê²ƒ 1ê°œ: SCRIPT_URL
 * =============================== */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxiC5h37_p7_m-mDOgffQjSIgJQc2q82d1SdrZZkVAgGIeK2UH_DaxIWMDW0J-kf_xfOA/exec";

/** ===============================
 * ê´€ë¦¬ì í† í° ì €ì¥ í‚¤(ë‹¨ëŒ€ë°© ë…¸íŠ¸ë¶ì—ë§Œ ì €ì¥)
 * =============================== */
const ADMIN_TOKEN_KEY = "ì •ì°¬";

/** ====== ìƒíƒœ ë°ì´í„°(êµ¬ê¸€ì‹œíŠ¸ items) ====== */
let items = [];               // [{item,itemNo,status,renterName,renterStudent,rentTime,returnTime}, ...]
let itemMap = new Map();      // key: "item::itemNo" -> row object
let activeSet = new Set();    // rentedì¸ ê²ƒë§Œ item::itemNo

function nowLabel() {
  const d=new Date();
  const y=d.getFullYear();
  const m=String(d.getMonth()+1).padStart(2,"0");
  const day=String(d.getDate()).padStart(2,"0");
  const el=document.getElementById("todayLabel");
  if(el) el.textContent=`(${y}.${m}.${day} ê¸°ì¤€)`;
}

function getAdminToken() {
  return localStorage.getItem(ADMIN_TOKEN_KEY) || "";
}
function isAdmin() {
  return !!getAdminToken();
}
function setModeUI() {
  const dot = document.getElementById("modeDot");
  const text = document.getElementById("modeText");
  if (isAdmin()) {
    dot.classList.add("admin");
    dot.classList.remove("view");
    text.textContent = "ê´€ë¦¬ì ëª¨ë“œ(ë‹¨ëŒ€ë°© ì „ìš©)";
  } else {
    dot.classList.add("view");
    dot.classList.remove("admin");
    text.textContent = "ì¡°íšŒ ì „ìš© ëª¨ë“œ";
  }

  // ê´€ë¦¬ìë§Œ ê°€ëŠ¥: ëŒ€ì—¬/ë°˜ë‚©/ì´ˆê¸°í™”
  document.getElementById("rentBtn").disabled = !isAdmin();
  document.getElementById("resetBtn").disabled = !isAdmin();

  // ì…ë ¥ì°½ë„ ì¡°íšŒ ì „ìš©ì¼ ë•ŒëŠ” ì ê·¸ëŠ” ê²Œ UXê°€ ë‚«ë‹¤
  document.getElementById("nameInput").disabled = !isAdmin();
  document.getElementById("studentInput").disabled = !isAdmin();
}

async function apiGetItems() {
  const res = await fetch(SCRIPT_URL, { method: "GET" });
  const json = await res.json();
  if (!json.ok) throw new Error(json.error || "GET failed");
  return json.items || [];
}

async function apiPost(payload) {
  const res = await fetch(SCRIPT_URL, {
    method: "POST",
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify(payload)
  });
  const json = await res.json();
  if (!json.ok) throw new Error(json.error || "POST failed");
  return json;
}

function rebuildIndex() {
  itemMap.clear();
  activeSet.clear();
  for (const r of items) {
    const key = `${r.item}::${r.itemNo}`;
    itemMap.set(key, r);
    if (String(r.status) === "rented" && String(r.itemNo) !== "âˆ") {
      activeSet.add(key);
    }
  }
}

/** items ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë¬¼í’ˆ/ë²ˆí˜¸ ì…€ë ‰íŠ¸ êµ¬ì„± */
function initItemSelect() {
  const sel = document.getElementById("itemSelect");
  sel.innerHTML = "";

  // item ëª©ë¡ ì¶”ì¶œ(ì •ë ¬)
  const itemNames = Array.from(new Set(items.map(x => String(x.item)))).sort((a,b)=>a.localeCompare(b,"ko"));

  for (const name of itemNames) {
    const o = document.createElement("option");
    o.value = name;
    o.textContent = name;
    sel.appendChild(o);
  }
}

function sortItemNo(a, b) {
  // "âˆ"ëŠ” ë§¨ ë’¤
  if (a === "âˆ" && b === "âˆ") return 0;
  if (a === "âˆ") return 1;
  if (b === "âˆ") return -1;
  const na = Number(a), nb = Number(b);
  if (!Number.isNaN(na) && !Number.isNaN(nb)) return na - nb;
  return String(a).localeCompare(String(b),"ko");
}

function updateItemNoSelect() {
  const item = document.getElementById("itemSelect").value;
  const sel = document.getElementById("itemNoSelect");
  sel.innerHTML = "";

  const nos = items
    .filter(x => String(x.item) === item)
    .map(x => String(x.itemNo))
    .sort(sortItemNo);

  for (const no of nos) {
    const o = document.createElement("option");
    o.value = no;
    const key = `${item}::${no}`;
    const row = itemMap.get(key);

    if (no !== "âˆ" && row && String(row.status) === "rented") {
      o.disabled = true;
      o.textContent = `${no}ë²ˆ (ëŒ€ì—¬ì¤‘)`;
    } else if (no === "âˆ") {
      o.textContent = `(ëŒ€ì—¬ ê°€ëŠ¥)`;
    } else {
      o.textContent = `${no}ë²ˆ`;
    }
    sel.appendChild(o);
  }

  // ì²« ë²ˆì§¸ enabled ì˜µì…˜ìœ¼ë¡œ ìë™ ì„ íƒ
  const first = [...sel.options].find(x => !x.disabled);
  sel.value = first ? first.value : "";
}

/** í…Œì´ë¸” ë Œë”: items ì‹œíŠ¸ í˜„ì¬ ìƒíƒœë¥¼ ê·¸ëŒ€ë¡œ í‘œì‹œ */
function renderTable() {
  const body = document.getElementById("tableBody");
  body.innerHTML = "";

  const sorted = [...items].sort((a,b)=>{
    const ia = String(a.item).localeCompare(String(b.item),"ko");
    if (ia !== 0) return ia;
    return sortItemNo(String(a.itemNo), String(b.itemNo));
  });

  sorted.forEach((r, i) => {
    const tr = document.createElement("tr");

    const status = String(r.status || "");
    const badgeClass = status === "rented" ? "rented" : "available";
    const badgeText = status === "rented" ? "ëŒ€ì—¬ì¤‘" : "ëŒ€ì—¬ê°€ëŠ¥";

    tr.innerHTML =
      `<td>${i+1}</td>` +
      `<td>${escapeHtml(String(r.item||""))}</td>` +
      `<td>${String(r.itemNo)==="âˆ" ? "-" : escapeHtml(String(r.itemNo))}</td>` +
      `<td><span class="badge ${badgeClass}">${badgeText}</span></td>` +
      `<td>${escapeHtml(String(r.renterName||""))}</td>` +
      `<td>${escapeHtml(String(r.renterStudent||""))}</td>` +
      `<td>${formatTime(r.rentTime)}</td>` +
      `<td>${formatTime(r.returnTime)}</td>` +
      `<td></td>`;

    const btn = document.createElement("button");
    btn.textContent = "ë°˜ë‚©";

    const canReturn = isAdmin() && status === "rented";
    btn.disabled = !canReturn;

    btn.onclick = async () => {
      try {
        await returnItem(String(r.item), String(r.itemNo));
      } catch (e) {
        alert(String(e.message || e));
      }
    };

    tr.lastChild.appendChild(btn);
    body.appendChild(tr);
  });
}

function formatTime(v) {
  if (!v) return "";
  // Apps Scriptê°€ Dateë¥¼ ë‚´ë³´ë‚´ë©´ ë¬¸ìì—´/ê°ì²´ í˜¼ìš©ë  ìˆ˜ ìˆì–´ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
  try {
    // ì´ë¯¸ "2026-..." ê°™ì€ ë¬¸ìì—´ì´ë©´ ê·¸ëŒ€ë¡œ
    if (typeof v === "string") return v;
    // ìˆ«ìë©´ Dateë¡œ
    if (typeof v === "number") return new Date(v).toLocaleString("ko-KR");
    // ê·¸ ì™¸ëŠ” stringify
    return String(v);
  } catch {
    return String(v);
  }
}

function escapeHtml(s) {
  return s
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/** ===== ê´€ë¦¬ì ë™ì‘(POST) ===== */
async function rentItem() {
  const item = document.getElementById("itemSelect").value;
  const itemNo = document.getElementById("itemNoSelect").value;
  const name = document.getElementById("nameInput").value.trim();
  const student = document.getElementById("studentInput").value.trim();

  if (!isAdmin()) {
    alert("ì¡°íšŒ ì „ìš© ëª¨ë“œì…ë‹ˆë‹¤. ëŒ€ì—¬ ì²˜ë¦¬ëŠ” ë‹¨ëŒ€ë°© ë…¸íŠ¸ë¶ì—ì„œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
    return;
  }
  if (!name || !student) {
    alert("ì´ë¦„ê³¼ í•™ë²ˆì„ ì…ë ¥í•˜ì„¸ìš”.");
    return;
  }

  const token = getAdminToken();
  await apiPost({ token, action: "rent", item, itemNo, name, student });

  document.getElementById("nameInput").value = "";
  document.getElementById("studentInput").value = "";
  await refresh();
}

async function returnItem(item, itemNo) {
  const token = getAdminToken();
  if (!token) throw new Error("ê´€ë¦¬ì í† í°ì´ í•„ìš”í•©ë‹ˆë‹¤.");
  await apiPost({ token, action: "return", item, itemNo });
  await refresh();
}

async function resetAll() {
  if (!isAdmin()) {
    alert("ì¡°íšŒ ì „ìš© ëª¨ë“œì…ë‹ˆë‹¤. ì´ˆê¸°í™”ëŠ” ë‹¨ëŒ€ë°© ë…¸íŠ¸ë¶ì—ì„œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
    return;
  }
  if (!confirm("ì •ë§ ëª¨ë“  ìƒíƒœë¥¼ ì´ˆê¸°í™”í•©ë‹ˆê¹Œ? (itemsë¥¼ ì „ë¶€ availableë¡œ ë˜ëŒë¦½ë‹ˆë‹¤)")) return;

  const token = getAdminToken();
  await apiPost({ token, action: "reset" });
  await refresh();
}

/** ===== ê´€ë¦¬ì ëª¨ë“œ í† í° ì„¤ì •/í•´ì œ ===== */
function setAdminToken() {
  const t = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
  if (!t) return;
  localStorage.setItem(ADMIN_TOKEN_KEY, t.trim());
  setModeUI();
  renderTable();
  updateItemNoSelect();
}

function clearAdminToken() {
  if (!confirm("ì´ ê¸°ê¸°ì—ì„œ ê´€ë¦¬ì ëª¨ë“œë¥¼ í•´ì œí• ê¹Œìš”?")) return;
  localStorage.removeItem(ADMIN_TOKEN_KEY);
  setModeUI();
  renderTable();
  updateItemNoSelect();
}

/** ===== ë°ì´í„° ë¡œë“œ/ê°±ì‹  ===== */
async function refresh() {
  try {
    items = await apiGetItems();
    rebuildIndex();

    // ì…€ë ‰íŠ¸ ì´ˆê¸°í™”(ì²˜ìŒ 1íšŒ ë˜ëŠ” items êµ¬ì¡° ë°”ë€ ê²½ìš°)
    initItemSelect();
    updateItemNoSelect();

    renderTable();
  } catch (e) {
    alert("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.\n" + String(e.message || e));
  }
}

/** ===== ì´ë²¤íŠ¸ ë°”ì¸ë”© ===== */
document.getElementById("rentBtn").onclick = () => rentItem().catch(e=>alert(String(e.message||e)));
document.getElementById("resetBtn").onclick = () => resetAll().catch(e=>alert(String(e.message||e)));
document.getElementById("refreshBtn").onclick = () => refresh();
document.getElementById("itemSelect").onchange = updateItemNoSelect;

document.getElementById("adminSetBtn").onclick = setAdminToken;
document.getElementById("adminClearBtn").onclick = clearAdminToken;

document.getElementById("closeGuideBtn").onclick = () => {
  document.getElementById("guideOverlay").style.display = "none";
};

// ì´ˆê¸° ì‹¤í–‰
nowLabel();
setModeUI();
refresh();
</script>

</body>
</html>

